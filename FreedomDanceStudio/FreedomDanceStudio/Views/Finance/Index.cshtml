@model List<FreedomDanceStudio.Models.FinancialTransaction>
@{
    ViewData["Title"] = "Финансы";
    var stats = ViewBag.Stats as dynamic;
}

<div class="container mt-4">
    <h2>@ViewData["Title"]</h2>

    <!-- Дашборд со сводной статистикой -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5>Доходы</h5>
                    <h3>@((stats?.TotalIncome ?? 0).ToString("C"))</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5>Расходы</h5>
                    <h3>@((stats?.TotalExpense ?? 0).ToString("C"))</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5>Баланс</h5>
                    <h3>@((stats?.Balance ?? 0).ToString("C"))</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Форма фильтрации -->
    <form method="get" class="mb-4">
        <div class="row">
            <div class="col-md-3">
                <label>Начало периода</label>
                <input type="date" name="startDate" class="form-control"
                       value="@(ViewBag.StartDate?.ToString("yyyy-MM-dd") ?? "")">
            </div>
            <div class="col-md-3">
                <label>Конец периода</label>
                <input type="date" name="endDate" class="form-control"
                       value="@(ViewBag.EndDate?.ToString("yyyy-MM-dd") ?? "")">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary mt-4">Применить</button>
            </div>
            <div class="col-md-4 text-end">
                <a asp-action="Create" class="btn btn-success mt-4">
                    <i class="bi bi-plus"></i> Добавить транзакцию
                </a>
                <!-- Кнопка для открытия модального окна расчёта ЗП -->
                <button type="button" class="btn btn-warning mt-4 ms-2" id="openSalaryCalcBtn">
                    <i class="bi bi-calculator"></i> Рассчитать ЗП
                </button>
            </div>
        </div>
    </form>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Таблица транзакций -->
    <table class="table table-striped">
        <thead>
        <tr>
            <th>Дата</th>
            <th>Тип</th>
            <th>Сумма</th>
            <th>Категория</th>
            <th>Описание</th>
            <th>Источник</th>
            <th class="text-end">Действия</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var transaction in Model)
        {
            <tr>
                <td>@transaction.TransactionDate.ToString("dd.MM.yyyy")</td>
                <td>
                <span class="badge @(transaction.TransactionType == "Income" ? "bg-success" : "bg-danger")">
                    @transaction.TransactionType
                </span>
                </td>
                <td>@transaction.Amount.ToString("C")</td>
                <td>@(transaction.Category ?? "-")</td>
                <td>@(transaction.Description ?? "-")</td>
                <td>
                    @if (transaction.EmployeeSalaryCalculationId.HasValue)
                    {
                        <span class="text-muted">Расчёт ЗП №@transaction.EmployeeSalaryCalculationId</span>
                    }
                    else if (transaction.AbonnementSale != null)
                    {
                        <span class="text-muted">Продажа абонемента</span>
                    }
                    else if (transaction.IsManual)
                    {
                        <span class="text-muted">Ручная</span>
                    }
                </td>
                <td class="text-end">
                    <!-- Кнопка удаления -->
                    <button type="button" class="btn btn-sm btn-outline-danger delete-button"
                            data-bs-toggle="modal"
                            data-bs-target="#deleteModal"
                            data-transaction-id="@transaction.Id"
                            data-transaction-amount="@transaction.Amount.ToString("C")"
                            data-transaction-type="@transaction.TransactionType">
                        <i class="bi bi-trash"></i> Удалить
                    </button>
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

<!-- Модальное окно подтверждения удаления (существующий код) -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить эту транзакцию? Это действие нельзя отменить.</p>

                <dl class="row">
                    <dt class="col-sm-4">ID транзакции</dt>
                    <dd class="col-sm-8" id="modalTransactionId">-</dd>

                    <dt class="col-sm-4">Тип</dt>
                    <dd class="col-sm-8">
                        <span id="modalTransactionType" class="badge"></span>
                    </dd>

                    <dt class="col-sm-4">Сумма</dt>
                    <dd class="col-sm-8" id="modalTransactionAmount">-</dd>
                </dl>
            </div>
            <div class="modal-footer">
                <form id="deleteForm" asp-controller="Finance" asp-action="DeleteConfirmed" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="hiddenTransactionId" />
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Удалить безвозвратно
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно расчёта заработной платы (новый код) -->
<div class="modal fade" id="salaryCalcModal" tabindex="-1" aria-labelledby="salaryCalcModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="salaryCalcModalLabel">Расчёт заработной платы</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="salaryCalcForm" asp-controller="EmployeeSalaryCalculation" asp-action="Create" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="row">
                        <!-- Левая колонка: выбор сотрудника и период -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Сотрудник <span class="text-danger">*</span></label>
                                <select class="form-select" id="employeeSelect" name="EmployeeId" required>
                                    <option value="">Выберите сотрудника</option>
                                    @if (ViewBag.Employees != null)
                                    {
                                        @foreach (var employee in (List<FreedomDanceStudio.Models.Employee>)ViewBag.Employees)
                                        {
                                            <option value="@employee.Id">@employee.FirstName @employee.LastName</option>
                                        }
                                    }
                                </select>
                            </div>

            <div class="row mb-3">
                <div class="col">
            <label class="form-label">Дата от <span class="text-danger">*</span></label>
            <input type="datetime-local" class="form-control" id="startDate" name="StartDate" required />
                </div>
                <div class="col">
            <label class="form-label">Дата до <span class="text-danger">*</span></label>
            <input type="datetime-local" class="form-control" id="endDate" name="EndDate" required />
                </div>
            </div>
        </div>

        <!-- Правая колонка: финансовые данные -->
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Тип оплаты</label>
                <input type="text" class="form-control" value="За час" readonly />
                <input type="hidden" name="PaymentType" value="Hourly" />
            </div>

            <div class="row mb-3">
                <div class="col">
            <label class="form-label">Ставка за час <span class="text-danger">*</span></label>
            <input type="number" class="form-control" id="hourlyRate" name="HourlyRate" step="0.01" required readonly />
                </div>
                <div class="col">
            <label class="form-label">Всего часов <span class="text-danger">*</span></label>
            <input type="number" class="form-control" id="totalHours" name="TotalHours" step="0.01" required readonly
                   data-val="true"
                   data-val-number="Поле 'Всего часов' должно быть числом." />
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Итого к выплате <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="totalAmount" name="TotalAmount" step="0.01" required readonly />
            </div>
        </div>
    </div>

    <!-- Примечания -->
    <div class="alert alert-info">
        <small>
            <i class="bi bi-info-circle"></i> Поля со значком <span class="text-danger">*</span> обязательны для заполнения.<br>
            Поля «Ставка за час», «Всего часов» и «Итого к выплате» заполняются автоматически.
        </small>
    </div>
</div>
<div class="modal-footer">
    <button type="submit" class="btn btn-primary">
        <i class="bi bi-check-circle"></i> Сохранить расчёт
    </button>
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
</div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/finance/finance-page.js"></script>
    <script src="~/js/salary-calc.js"></script>
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
