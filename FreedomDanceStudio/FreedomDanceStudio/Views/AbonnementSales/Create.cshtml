@model AbonnementSale
@{
    ViewData["Title"] = "Создание продажи абонемента";
}


<div class="container mt-4">
    <h2>@ViewData["Title"]</h2>

    <form method="post" id="abonnementForm">
        <input type="hidden" asp-for="Id" />


        <div class="row">
            <div class="col-md-6">
                <!-- Поле выбора клиента -->
                <div class="mb-3">
                    <label asp-for="ClientId" class="form-label">Клиент</label>
                    <select asp-for="ClientId" asp-items="ViewBag.Clients"
                            class="form-select" required>
                        <option value="">-- Выберите клиента --</option>
                    </select>
                    <span asp-validation-for="ClientId" class="text-danger"></span>
                </div>

                <!-- Поле выбора услуги -->
                <div class="mb-3">
                    <label asp-for="ServiceId" class="form-label">Тип абонемента</label>
                    <select asp-for="ServiceId" asp-items="ViewBag.Services"
                            class="form-select" required id="ServiceSelect">
                        <option value="">-- Выберите услугу --</option>
                    </select>
                    <span asp-validation-for="ServiceId" class="text-danger"></span>
                </div>

                <!-- Дата продажи (только для чтения) -->
                <div class="mb-3">
                    <label asp-for="SaleDate" class="form-label">Дата продажи</label>
                    <input asp-for="SaleDate" type="date" class="form-control"
                           readonly />
                    <span asp-validation-for="SaleDate" class="text-danger"></span>
                </div>

                <!-- Начало действия -->
                <div class="mb-3">
                    <label asp-for="StartDate" class="form-label">Начало действия</label>
                    <input asp-for="StartDate" type="date" class="form-control" required />
                    <span asp-validation-for="StartDate" class="text-danger"></span>
                </div>

                <!-- Блок с информацией о выбранной услуге -->
                <div id="ServiceInfo" class="alert alert-info mb-3" style="display:none;">
                    <strong>Выбрана услуга:</strong> <span id="ServiceNameDisplay"></span><br>
                    <strong>Цена:</strong> <span id="PriceDisplay"></span> ₽<br>
                    <strong>Срок действия:</strong> <span id="DurationDisplay"></span> дней
                </div>

                <!-- Окончание действия (только для чтения, пересчитывается автоматически) -->
                <div class="mb-3">
                    <label class="form-label">Окончание действия</label>
                    <input type="date" class="form-control" readonly
                           id="EndDateDisplay" />
                    <!-- Скрытое поле для передачи в контроллер -->
                    <input asp-for="EndDate" type="hidden" id="EndDateHidden" />
                    <small class="text-muted">Пересчитывается автоматически при смене услуги или даты начала</small>
                    <span asp-validation-for="EndDate" class="text-danger"></span>
                </div>

                <!-- Максимальное количество посещений (обязательно) -->
                <div class="mb-3">
                    <label asp-for="MaxVisits" class="form-label">Максимальное количество посещений <span class="text-danger">*</span></label>
                    <input asp-for="MaxVisits" class="form-control" type="number" min="0" required />
                    <small class="text-muted">0 — безлимит</small>
                    <span asp-validation-for="MaxVisits" class="text-danger"></span>
                </div>

                <button type="submit" class="btn btn-primary">Сохранить</button>
                <a asp-action="Index" class="btn btn-secondary">Отмена</a>
            </div>
        </div>
    </form>
</div>


<!-- Модальное окно ошибки -->
<div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="validationModalLabel">Ошибка заполнения</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="validationMessage">Пожалуйста, заполните все обязательные поля.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('abonnementForm');
            const maxVisitsInput = document.getElementById('@Html.IdFor(m => m.MaxVisits)');
            const validationModalEl = document.getElementById('validationModal');
            const validationMessageEl = document.getElementById('validationMessage');

            // Инициализация модального окна Bootstrap
            const validationModal = new bootstrap.Modal(validationModalEl);

            // Обработчик отправки формы
            form.addEventListener('submit', function(event) {
                // Проверяем общую валидность формы
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();

                    // Проверяем конкретное поле MaxVisits
                    if (!maxVisitsInput.value || maxVisitsInput.value.trim() === '') {
                validationMessageEl.textContent = 'Поле "Максимальное количество посещений" обязательно для заполнения.';
            } else {
                validationMessageEl.textContent = 'Пожалуйста, заполните все обязательные поля.';
            }

            // Показываем модальное окно
            validationModal.show();
        }

        // Добавляем стили для индикации ошибок
        form.classList.add('was-validated');
    });

    // Элементы для пересчёта даты окончания
    const serviceSelect = document.getElementById('ServiceSelect');
    const startDateInput = document.getElementById('StartDate');
    const endDateDisplay = document.getElementById('EndDateDisplay');
    const endDateHidden = document.getElementById('EndDateHidden');
    const serviceInfo = document.getElementById('ServiceInfo');
    const serviceNameDisplay = document.getElementById('ServiceNameDisplay');
    const priceDisplay = document.getElementById('PriceDisplay');
    const durationDisplay = document.getElementById('DurationDisplay');

    // Функция пересчёта даты окончания
    function recalculateEndDate() {
        const startDateStr = startDateInput.value;
        const serviceId = serviceSelect.value;

        // Если нет данных, очищаем EndDate
        if (!startDateStr || !serviceId) {
            endDateDisplay.value = '';
            endDateHidden.value = '';
            if (serviceInfo) serviceInfo.style.display = 'none';
            return;
        }

        const url = `${window.location.origin}/AbonnementSales/GetServiceDuration?serviceId=${serviceId}`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const startDate = new Date(startDateStr);
                const newEndDate = new Date(startDate);
                newEndDate.setDate(startDate.getDate() + data.durationDays);

                // Форматируем в ISO для скрытого поля
                const isoEndDate = newEndDate.toISOString().split('T')[0];
                endDateDisplay.value = isoEndDate;
                endDateHidden.value = isoEndDate;

                // Обновляем информацию об услуге
                if (serviceNameDisplay) serviceNameDisplay.textContent = data.serviceName;
                if (priceDisplay) priceDisplay.textContent = data.price;
                if (durationDisplay) durationDisplay.textContent = data.durationDays;
                if (serviceInfo) serviceInfo.style.display = 'block';
            })
            .catch(error => {
                console.error('Ошибка при получении данных:', error);
                alert(`Не удалось загрузить данные услуги: ${error.message}. Проверьте подключение к сети.`);

                // При ошибке очищаем EndDate
                endDateDisplay.value = '';
                endDateHidden.value = '';
                if (serviceInfo) serviceInfo.style.display = 'none';
            });
    }

    // Обработчики событий для пересчёта
    if (serviceSelect) serviceSelect.addEventListener('change', recalculateEndDate);
    if (startDateInput) startDateInput.addEventListener('change', recalculateEndDate);


    // Инициализация при загрузке (если элементы найдены и есть выбор)
    if (serviceSelect && startDateInput && serviceSelect.value && startDateInput.value) {
        recalculateEndDate();
    }
});
</script>
}
